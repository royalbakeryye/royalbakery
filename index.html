<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Royal Bakery | Ø§Ù„Ù…Ø®Ø¨Ø² Ø§Ù„Ù…Ù„ÙƒÙŠ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --bg-color: #fcf8f0;
            --primary-orange: #f38230;
            --dark-black: #1a1a1a;
            --white: #ffffff;
            --gold: #d4a017;
            --whatsapp-green: #25d366;
            --red: #e74c3c;
            --gray: #f0f0f0;
        }

        body {
            margin: 0; background-color: var(--bg-color);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding-bottom: 100px; color: var(--dark-black);
            -webkit-tap-highlight-color: transparent;
        }

        header {
            background: var(--white); padding: 15px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            position: sticky; top: 0; z-index: 1000;
        }

        .logo { font-size: 20px; font-weight: bold; color: var(--gold); letter-spacing: 1px; }

        .categories-nav {
            display: flex; gap: 10px; padding: 15px; overflow-x: auto;
            background: var(--white); border-bottom: 1px solid #eee;
            position: sticky; top: 55px; z-index: 999;
            scrollbar-width: none;
        }
        .categories-nav::-webkit-scrollbar { display: none; }

        .cat-btn {
            background: var(--gray); border: 1px solid #ddd; padding: 8px 22px;
            border-radius: 20px; cursor: pointer; white-space: nowrap; 
            font-weight: bold; transition: 0.3s; font-size: 14px;
        }
        .cat-btn.active { 
            background: var(--primary-orange); color: white; 
            border-color: var(--primary-orange); box-shadow: 0 4px 10px rgba(243, 130, 48, 0.3); 
        }

        .products-container {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 15px; padding: 15px; max-width: 1000px; margin: 0 auto;
        }

        .card {
            background: var(--white); border-radius: 20px; padding: 12px;
            text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            transition: transform 0.2s;
        }
        .card:active { transform: scale(0.98); }

        .product-img { width: 100%; height: 120px; object-fit: cover; border-radius: 15px; background: #f9f9f9; cursor: zoom-in; }
        .product-title { font-weight: bold; margin: 8px 0 2px; font-size: 14px; height: 35px; overflow: hidden; }
        .product-price { color: var(--primary-orange); font-weight: bold; margin-bottom: 10px; font-size: 16px; }

        .add-btn {
            background: var(--primary-orange); color: white; border: none;
            width: 100%; padding: 10px; border-radius: 12px; cursor: pointer; font-weight: bold;
        }

        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 2000; justify-content: center; align-items: flex-end;
        }

        .modal-content {
            background: white; width: 100%; max-width: 500px; border-radius: 30px 30px 0 0;
            padding: 25px; max-height: 90vh; overflow-y: auto; animation: slideUp 0.3s ease-out;
        }

        #imageViewer {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 3000; justify-content: center; align-items: center;
        }
        #fullImage { max-width: 90%; max-height: 80%; border-radius: 10px; border: 3px solid white; }

        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .input-field {
            width: 100%; padding: 12px; margin: 6px 0; border: 1px solid #ddd; border-radius: 10px; 
            box-sizing: border-box; font-family: inherit; font-size: 16px; outline: none;
        }

        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0; background: var(--dark-black);
            display: flex; justify-content: space-between; align-items: center; padding: 15px 25px; z-index: 1500;
        }
        
        .qty-btn { width: 32px; height: 32px; border-radius: 50%; border: 1px solid #ddd; cursor: pointer; background: white; font-weight: bold; }
        .delete-item { color: var(--red); background: none; border: none; font-size: 20px; cursor: pointer; }

        .free-shipping-badge {
            background: #e8f5e9; color: #2e7d32; padding: 10px; border-radius: 12px;
            font-size: 14px; font-weight: bold; text-align: center; margin-bottom: 15px;
            border: 1px dashed #2e7d32;
        }

        #status-dot { width: 10px; height: 10px; border-radius: 50%; background: #bbb; }

        /* Ø´Ø§Ø´Ø© Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…Ø¤Ù‚Øª */
        #closed-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(26, 26, 26, 0.98); z-index: 10000;
            display: none; flex-direction: column; justify-content: center;
            align-items: center; color: white; text-align: center; padding: 30px;
        }

        /* ØªÙ†Ø³ÙŠÙ‚ Ø²Ø± Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯ */
        .location-btn {
            width: 100%; background: #f0f7ff; color: #007bff; border: 1px solid #cce5ff; 
            padding: 12px; border-radius: 10px; margin: 5px 0 10px; cursor: pointer; 
            font-weight: bold; font-size: 14px; display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .location-btn.success { background: #e8f5e9; color: #2e7d32; border-color: #c8e6c9; }
    </style>
</head>
<body>

<div id="closed-overlay">
    <div style="font-size: 60px; margin-bottom: 20px;">ğŸ </div>
    <h2 style="color: var(--primary-orange);">Ù†Ø¹ØªØ°Ø±ØŒ Ø§Ù„Ù…ØªØ¬Ø± Ù…ØºÙ„Ù‚ Ø­Ø§Ù„ÙŠØ§Ù‹</h2>
    <p id="closed-reason" style="font-size: 18px; line-height: 1.6; max-width: 400px;"></p>
    <button onclick="location.reload()" style="margin-top:20px; padding:10px 20px; border-radius:10px; border:none; background:var(--primary-orange); color:white; font-weight:bold;">ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø© ğŸ”„</button>
</div>

<header>
    <div class="logo">ğŸ‘‘ ROYAL BAKERY</div>
    <div id="status-dot"></div>
</header>

<div class="categories-nav" id="catNav">
    <button class="cat-btn active" onclick="filterProducts('all', this)">âœ¨ Ø§Ù„ÙƒÙ„</button>
    <button class="cat-btn" onclick="filterProducts('pastry', this)">ğŸ¥ ÙØ·Ø§Ø¦Ø±</button>
    <button class="cat-btn" onclick="filterProducts('drink', this)">â˜• Ù…Ø´Ø±ÙˆØ¨Ø§Øª</button>
    <button class="cat-btn" onclick="filterProducts('cake', this)">ğŸ° Ø­Ù„ÙˆÙŠØ§Øª</button>
</div>

<div id="loading" style="text-align:center; padding: 50px; color: #888;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©...</div>

<div class="products-container" id="products"></div>

<div id="imageViewer" onclick="closeImageViewer()">
    <img id="fullImage" src="">
</div>

<div class="bottom-nav">
    <div style="color: white; font-size: 14px;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <span id="nav-total" style="color: var(--gold); font-weight: bold; font-size: 18px;">0</span> Ø±ÙŠØ§Ù„</div>
    <div onclick="toggleModal()" style="color: white; cursor: pointer; font-weight: bold; background: var(--primary-orange); padding: 10px 20px; border-radius: 15px;">
        ğŸ›’ Ø§Ù„Ø³Ù„Ø© (<span id="nav-count">0</span>)
    </div>
</div>

<div id="cartModal" class="modal">
    <div class="modal-content">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h3 style="margin: 0;">Ø³Ù„Ø© Ø§Ù„ØªØ³ÙˆÙ‚ ğŸ›’</h3>
            <button onclick="toggleModal()" style="font-size: 28px; border: none; background: none; color: #ccc; cursor: pointer;">&times;</button>
        </div>

        <div class="free-shipping-badge">ğŸ›µ Ø®Ø¯Ù…Ø© Ø§Ù„ØªÙˆØµÙŠÙ„ Ù…Ø¬Ø§Ù†ÙŠØ© Ù„Ù„Ø¬Ù…ÙŠØ¹!</div>
        
        <div id="cartItemsList"></div>

        <div style="margin-top: 20px; border-top: 2px dashed #eee; padding-top: 15px;">
            <input type="text" id="custName" class="input-field" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„" oninput="saveUserData()">
            <input type="tel" id="custPhone" class="input-field" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„" oninput="saveUserData()">
            <textarea id="fullAddress" class="input-field" style="height: 60px; resize: none;" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¨Ø§Ù„ØªÙØµÙŠÙ„" oninput="saveUserData()"></textarea>
            
            <button id="getLocBtn" onclick="getLocation()" class="location-btn">
                ğŸ“ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ (GPS)
            </button>

            <textarea id="orderNotes" class="input-field" style="height: 60px; resize: none; background: #fffcf0; border-color: #f3e5ab;" placeholder="Ù‡Ù„ Ù„Ø¯ÙŠÙƒ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©ØŸ"></textarea>
        </div>

        <div style="background: #fff9f5; padding: 15px; border-radius: 15px; margin: 15px 0; text-align: center; border: 1px solid #ffe0cc;">
            <span style="font-size: 18px; font-weight: bold;">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ: <span id="modalTotal" style="color:var(--primary-orange);">0</span> Ø±ÙŠØ§Ù„</span>
        </div>

        <button id="sendOrderBtn" onclick="handleOrder()" style="background: var(--whatsapp-green); color: white; border: none; width: 100%; padding: 16px; border-radius: 15px; font-size: 17px; font-weight: bold; cursor: pointer;">
            ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ ğŸ’¬
        </button>
        
        <button onclick="clearCart()" style="width: 100%; background: none; border: none; color: var(--red); margin-top: 15px; cursor: pointer;">ğŸ—‘ï¸ ØªÙØ±ÙŠØº Ø§Ù„Ø³Ù„Ø©</button>
    </div>
</div>

<script>
    const SUPABASE_URL = 'https://gemnsdsexkbyfdpozcwu.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdlbW5zZHNleGtieWZkcG96Y3d1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY3NDgzNzcsImV4cCI6MjA4MjMyNDM3N30.QQt3zYL5rF4kr1u7cy2H_w3D08_GubhEL-Jpbdusjkc';
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let allProducts = [];
    let cart = JSON.parse(localStorage.getItem('royal_bakery_cart')) || {};
    let storeSettings = { whatsapp_number: '967783409904', is_open: true, closing_message: 'Ø§Ù„Ù…Ø­Ù„ Ù…ØºÙ„Ù‚ Ø­Ø§Ù„ÙŠØ§Ù‹.' };
    let userLocationUrl = ""; 

    window.onload = async () => {
        loadUserData();
        await fetchSettings();
        fetchProducts();
    };

    function getLocation() {
        const btn = document.getElementById('getLocBtn');
        if (navigator.geolocation) {
            btn.innerText = "â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ...";
            navigator.geolocation.getCurrentPosition((position) => {
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;
                userLocationUrl = `https://www.google.com/maps?q=${lat},${lon}`;
                btn.innerText = "âœ… ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ù†Ø¬Ø§Ø­";
                btn.classList.add('success');
            }, (error) => {
                alert("ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªÙØ¹ÙŠÙ„ GPS ÙˆØ§Ù„Ø³Ù…Ø§Ø­ Ù„Ù„Ù…ØªØµÙØ­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„.");
                btn.innerText = "ğŸ“ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ (GPS)";
            });
        } else {
            alert("Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹.");
        }
    }

    async function fetchSettings() {
        try {
            const { data, error } = await _supabase.from('store_settings').select('*').limit(1).single();
            if (data) {
                storeSettings = data;
                if (!storeSettings.is_open) {
                    document.getElementById('closed-reason').innerText = storeSettings.closing_message;
                    document.getElementById('closed-overlay').style.display = 'flex';
                }
            }
        } catch (e) { console.log("Settings Load Error", e); }
    }

    async function fetchProducts() {
        try {
            const { data, error } = await _supabase.from('products').select('*');
            if (error) throw error;
            allProducts = data;
            document.getElementById('loading').style.display = 'none';
            document.getElementById('status-dot').style.background = '#2ecc71';
            renderProducts('all');
            updateUI(); 
        } catch (err) {
            document.getElementById('loading').innerText = "Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©.";
        }
    }

    function renderProducts(category) {
        const container = document.getElementById('products');
        const filtered = category === 'all' ? allProducts : allProducts.filter(p => p.type === category);
        container.innerHTML = filtered.map(p => `
            <div class="card">
                <img src="${p.img}" class="product-img" onclick="openImageViewer('${p.img}')" onerror="this.src='https://via.placeholder.com/150?text=Royal+Bakery'">
                <div class="product-title">${p.name}</div>
                <div class="product-price">${p.price} Ø±ÙŠØ§Ù„</div>
                <button class="add-btn" onclick="addToCart(${p.id})">Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø©</button>
            </div>
        `).join('');
    }

    function openImageViewer(src) {
        document.getElementById('fullImage').src = src;
        document.getElementById('imageViewer').style.display = 'flex';
    }

    function closeImageViewer() {
        document.getElementById('imageViewer').style.display = 'none';
    }

    function filterProducts(type, btn) {
        document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        renderProducts(type);
    }

    function addToCart(id) {
        const item = allProducts.find(x => x.id === id);
        if (cart[id]) cart[id].qty++;
        else cart[id] = { ...item, qty: 1 };
        updateUI();
    }

    function changeQty(id, delta) {
        cart[id].qty += delta;
        if (cart[id].qty <= 0) delete cart[id];
        updateUI();
    }

    function removeItem(id) {
        delete cart[id];
        updateUI();
    }

    function clearCart() {
        cart = {};
        updateUI();
    }

    function updateUI() {
        let count = 0, total = 0;
        const list = document.getElementById('cartItemsList');
        list.innerHTML = '';
        for (let id in cart) {
            count += cart[id].qty;
            total += (cart[id].qty * cart[id].price);
            list.innerHTML += `
                <div style="display:flex; justify-content:space-between; align-items:center; padding:10px 0; border-bottom:1px solid #eee;">
                    <div style="flex:1; font-size:14px;"><b>${cart[id].name}</b><br>${cart[id].price} Ø±ÙŠØ§Ù„</div>
                    <div style="display:flex; align-items:center; gap:8px;">
                        <button class="qty-btn" onclick="changeQty(${id}, -1)">-</button>
                        <span>${cart[id].qty}</span>
                        <button class="qty-btn" onclick="changeQty(${id}, 1)">+</button>
                        <button class="delete-item" onclick="removeItem(${id})">&times;</button>
                    </div>
                </div>`;
        }
        document.getElementById('nav-count').innerText = count;
        document.getElementById('nav-total').innerText = total;
        document.getElementById('modalTotal').innerText = total;
        localStorage.setItem('royal_bakery_cart', JSON.stringify(cart));
    }

    function saveUserData() {
        const userData = {
            name: document.getElementById('custName').value,
            phone: document.getElementById('custPhone').value,
            address: document.getElementById('fullAddress').value
        };
        localStorage.setItem('royal_bakery_user', JSON.stringify(userData));
    }

    function loadUserData() {
        const savedData = JSON.parse(localStorage.getItem('royal_bakery_user'));
        if (savedData) {
            document.getElementById('custName').value = savedData.name || '';
            document.getElementById('custPhone').value = savedData.phone || '';
            document.getElementById('fullAddress').value = savedData.address || '';
        }
    }

    async function handleOrder() {
        const name = document.getElementById('custName').value.trim();
        const phone = document.getElementById('custPhone').value.trim();
        const address = document.getElementById('fullAddress').value.trim();
        const notes = document.getElementById('orderNotes').value.trim();
        const total = document.getElementById('modalTotal').innerText;

        if (!name || !address || Object.keys(cart).length === 0) {
            return alert("ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬Ø§Øª Ù„Ù„Ø³Ù„Ø© ğŸ“‹");
        }

        const btn = document.getElementById('sendOrderBtn');
        btn.disabled = true;
        btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØªØ¬Ø±...";

        try {
            const { data: latestStatus } = await _supabase.from('store_settings').select('is_open, closing_message').limit(1).single();
            
            if (latestStatus && !latestStatus.is_open) {
                alert("Ø¹Ø°Ø±Ø§Ù‹ØŒ ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ØªØ¬Ø± Ù„Ù„ØªÙˆ: " + latestStatus.closing_message);
                location.reload(); 
                return;
            }

            await _supabase.from('orders').insert([{
                customer_name: name,
                phone: phone,
                address: address,
                location_url: userLocationUrl,
                items: cart,
                total_price: parseFloat(total),
                status: 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©',
                notes: notes
            }]);

            let message = `*ğŸ§¾ ÙØ§ØªÙˆØ±Ø© Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯Ø© - Ø§Ù„Ù…Ø®Ø¨Ø² Ø§Ù„Ù…Ù„ÙƒÙŠ*ğŸ‘‘%0A`;
            message += `------------------------------%0A`;
            message += `*Ø§Ù„Ø§Ø³Ù…:* ${name}%0A`;
            message += `*Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:* ${address}%0A`;
            
            if(userLocationUrl) {
                message += `*ğŸ“ Ø§Ù„Ù…ÙˆÙ‚Ø¹ (GPS):* ${userLocationUrl}%0A`;
            }

            if(notes) message += `*Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª:* ${notes}%0A`;
            message += `------------------------------%0A`;
            message += `*Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:*%0A`;

            for (let id in cart) {
                message += `â€¢ ${cart[id].name} (Ã—${cart[id].qty}) - ${cart[id].qty * cart[id].price} Ø±ÙŠØ§Ù„%0A`;
            }

            message += `------------------------------%0A`;
            message += `*ğŸ’° Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${total} Ø±ÙŠØ§Ù„*%0A`;
            message += `Ø´ÙƒØ±Ø§Ù‹ Ù„Ø§Ø®ØªÙŠØ§Ø±ÙƒÙ… Ø§Ù„Ù…Ø®Ø¨Ø² Ø§Ù„Ù…Ù„ÙƒÙŠ ğŸ¥–âœ¨`;

            window.open(`https://wa.me/${storeSettings.whatsapp_number}?text=${message}`, '_blank');
            
            cart = {};
            document.getElementById('orderNotes').value = "";
            userLocationUrl = ""; 
            updateUI();
            toggleModal();

        } catch (e) {
            alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
        } finally {
            btn.disabled = false;
            btn.innerText = "ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ ğŸ’¬";
        }
    }

    function toggleModal() {
        const m = document.getElementById('cartModal');
        m.style.display = (m.style.display === 'flex') ? 'none' : 'flex';
    }
</script>
</body>
</html>
            font-size: 14px; font-weight: bold; text-align: center; margin-bottom: 15px;
            border: 1px dashed #2e7d32;
        }

        #status-dot { width: 10px; height: 10px; border-radius: 50%; background: #bbb; }

        /* Ø´Ø§Ø´Ø© Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…Ø¤Ù‚Øª */
        #closed-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(26, 26, 26, 0.98); z-index: 10000;
            display: none; flex-direction: column; justify-content: center;
            align-items: center; color: white; text-align: center; padding: 30px;
        }

        /* ØªÙ†Ø³ÙŠÙ‚ Ø²Ø± Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯ */
        .location-btn {
            width: 100%; background: #f0f7ff; color: #007bff; border: 1px solid #cce5ff; 
            padding: 10px; border-radius: 10px; margin: 5px 0 10px; cursor: pointer; 
            font-weight: bold; font-size: 14px; display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .location-btn.success { background: #e8f5e9; color: #2e7d32; border-color: #c8e6c9; }
    </style>
</head>
<body>

<div id="closed-overlay">
    <div style="font-size: 60px; margin-bottom: 20px;">ğŸ </div>
    <h2 style="color: var(--primary-orange);">Ù†Ø¹ØªØ°Ø±ØŒ Ø§Ù„Ù…ØªØ¬Ø± Ù…ØºÙ„Ù‚ Ø­Ø§Ù„ÙŠØ§Ù‹</h2>
    <p id="closed-reason" style="font-size: 18px; line-height: 1.6; max-width: 400px;"></p>
    <button onclick="location.reload()" style="margin-top:20px; padding:10px 20px; border-radius:10px; border:none; background:var(--primary-orange); color:white; font-weight:bold;">ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø© ğŸ”„</button>
</div>

<header>
    <div class="logo">ğŸ‘‘ ROYAL BAKERY</div>
    <div id="status-dot"></div>
</header>

<div class="categories-nav" id="catNav">
    <button class="cat-btn active" onclick="filterProducts('all', this)">âœ¨ Ø§Ù„ÙƒÙ„</button>
    <button class="cat-btn" onclick="filterProducts('pastry', this)">ğŸ¥ ÙØ·Ø§Ø¦Ø±</button>
    <button class="cat-btn" onclick="filterProducts('drink', this)">â˜• Ù…Ø´Ø±ÙˆØ¨Ø§Øª</button>
    <button class="cat-btn" onclick="filterProducts('cake', this)">ğŸ° Ø­Ù„ÙˆÙŠØ§Øª</button>
</div>

<div id="loading" style="text-align:center; padding: 50px; color: #888;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©...</div>

<div class="products-container" id="products"></div>

<div id="imageViewer" onclick="closeImageViewer()">
    <img id="fullImage" src="">
</div>

<div class="bottom-nav">
    <div style="color: white; font-size: 14px;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <span id="nav-total" style="color: var(--gold); font-weight: bold; font-size: 18px;">0</span> Ø±ÙŠØ§Ù„</div>
    <div onclick="toggleModal()" style="color: white; cursor: pointer; font-weight: bold; background: var(--primary-orange); padding: 10px 20px; border-radius: 15px;">
        ğŸ›’ Ø§Ù„Ø³Ù„Ø© (<span id="nav-count">0</span>)
    </div>
</div>

<div id="cartModal" class="modal">
    <div class="modal-content">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h3 style="margin: 0;">Ø³Ù„Ø© Ø§Ù„ØªØ³ÙˆÙ‚ ğŸ›’</h3>
            <button onclick="toggleModal()" style="font-size: 28px; border: none; background: none; color: #ccc; cursor: pointer;">&times;</button>
        </div>

        <div class="free-shipping-badge">ğŸ›µ Ø®Ø¯Ù…Ø© Ø§Ù„ØªÙˆØµÙŠÙ„ Ù…Ø¬Ø§Ù†ÙŠØ© Ù„Ù„Ø¬Ù…ÙŠØ¹!</div>
        
        <div id="cartItemsList"></div>

        <div style="margin-top: 20px; border-top: 2px dashed #eee; padding-top: 15px;">
            <input type="text" id="custName" class="input-field" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„" oninput="saveUserData()">
            <input type="tel" id="custPhone" class="input-field" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„" oninput="saveUserData()">
            <textarea id="fullAddress" class="input-field" style="height: 60px; resize: none;" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¨Ø§Ù„ØªÙØµÙŠÙ„" oninput="saveUserData()"></textarea>
            
            <button id="getLocBtn" onclick="getLocation()" class="location-btn">
                ğŸ“ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ (GPS)
            </button>

            <textarea id="orderNotes" class="input-field" style="height: 60px; resize: none; background: #fffcf0; border-color: #f3e5ab;" placeholder="Ù‡Ù„ Ù„Ø¯ÙŠÙƒ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©ØŸ"></textarea>
        </div>

        <div style="background: #fff9f5; padding: 15px; border-radius: 15px; margin: 15px 0; text-align: center; border: 1px solid #ffe0cc;">
            <span style="font-size: 18px; font-weight: bold;">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ: <span id="modalTotal" style="color:var(--primary-orange);">0</span> Ø±ÙŠØ§Ù„</span>
        </div>

        <button id="sendOrderBtn" onclick="handleOrder()" style="background: var(--whatsapp-green); color: white; border: none; width: 100%; padding: 16px; border-radius: 15px; font-size: 17px; font-weight: bold; cursor: pointer;">
            ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ ğŸ’¬
        </button>
        
        <button onclick="clearCart()" style="width: 100%; background: none; border: none; color: var(--red); margin-top: 15px; cursor: pointer;">ğŸ—‘ï¸ ØªÙØ±ÙŠØº Ø§Ù„Ø³Ù„Ø©</button>
    </div>
</div>

<script>
    const SUPABASE_URL = 'https://gemnsdsexkbyfdpozcwu.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdlbW5zZHNleGtieWZkcG96Y3d1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY3NDgzNzcsImV4cCI6MjA4MjMyNDM3N30.QQt3zYL5rF4kr1u7cy2H_w3D08_GubhEL-Jpbdusjkc';
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let allProducts = [];
    let cart = JSON.parse(localStorage.getItem('royal_bakery_cart')) || {};
    let storeSettings = { whatsapp_number: '967783409904', is_open: true, closing_message: 'Ø§Ù„Ù…Ø­Ù„ Ù…ØºÙ„Ù‚ Ø­Ø§Ù„ÙŠØ§Ù‹.' };
    let userLocationUrl = ""; // Ù„ØªØ®Ø²ÙŠÙ† Ø±Ø§Ø¨Ø· Ø§Ù„Ù…ÙˆÙ‚Ø¹

    window.onload = async () => {
        loadUserData();
        await fetchSettings();
        fetchProducts();
    };

    // Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ
    function getLocation() {
        const btn = document.getElementById('getLocBtn');
        if (navigator.geolocation) {
            btn.innerText = "â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ...";
            navigator.geolocation.getCurrentPosition((position) => {
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;
                userLocationUrl = `https://www.google.com/maps?q=${lat},${lon}`;
                btn.innerText = "âœ… ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ù†Ø¬Ø§Ø­";
                btn.classList.add('success');
            }, (error) => {
                alert("ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªÙØ¹ÙŠÙ„ GPS ÙˆØ§Ù„Ø³Ù…Ø§Ø­ Ù„Ù„Ù…ØªØµÙØ­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„.");
                btn.innerText = "ğŸ“ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ (GPS)";
            });
        } else {
            alert("Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹.");
        }
    }

    async function fetchSettings() {
        try {
            const { data, error } = await _supabase.from('store_settings').select('*').limit(1).single();
            if (data) {
                storeSettings = data;
                if (!storeSettings.is_open) {
                    document.getElementById('closed-reason').innerText = storeSettings.closing_message;
                    document.getElementById('closed-overlay').style.display = 'flex';
                }
            }
        } catch (e) { console.log("Settings Load Error", e); }
    }

    async function fetchProducts() {
        try {
            const { data, error } = await _supabase.from('products').select('*');
            if (error) throw error;
            allProducts = data;
            document.getElementById('loading').style.display = 'none';
            document.getElementById('status-dot').style.background = '#2ecc71';
            renderProducts('all');
            updateUI(); 
        } catch (err) {
            document.getElementById('loading').innerText = "Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©.";
        }
    }

    function renderProducts(category) {
        const container = document.getElementById('products');
        const filtered = category === 'all' ? allProducts : allProducts.filter(p => p.type === category);
        container.innerHTML = filtered.map(p => `
            <div class="card">
                <img src="${p.img}" class="product-img" onclick="openImageViewer('${p.img}')" onerror="this.src='https://via.placeholder.com/150?text=Royal+Bakery'">
                <div class="product-title">${p.name}</div>
                <div class="product-price">${p.price} Ø±ÙŠØ§Ù„</div>
                <button class="add-btn" onclick="addToCart(${p.id})">Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø©</button>
            </div>
        `).join('');
    }

    function openImageViewer(src) {
        document.getElementById('fullImage').src = src;
        document.getElementById('imageViewer').style.display = 'flex';
    }

    function closeImageViewer() {
        document.getElementById('imageViewer').style.display = 'none';
    }

    function filterProducts(type, btn) {
        document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        renderProducts(type);
    }

    function addToCart(id) {
        const item = allProducts.find(x => x.id === id);
        if (cart[id]) cart[id].qty++;
        else cart[id] = { ...item, qty: 1 };
        updateUI();
    }

    function changeQty(id, delta) {
        cart[id].qty += delta;
        if (cart[id].qty <= 0) delete cart[id];
        updateUI();
    }

    function removeItem(id) {
        delete cart[id];
        updateUI();
    }

    function clearCart() {
        cart = {};
        updateUI();
    }

    function updateUI() {
        let count = 0, total = 0;
        const list = document.getElementById('cartItemsList');
        list.innerHTML = '';
        for (let id in cart) {
            count += cart[id].qty;
            total += (cart[id].qty * cart[id].price);
            list.innerHTML += `
                <div style="display:flex; justify-content:space-between; align-items:center; padding:10px 0; border-bottom:1px solid #eee;">
                    <div style="flex:1; font-size:14px;"><b>${cart[id].name}</b><br>${cart[id].price} Ø±ÙŠØ§Ù„</div>
                    <div style="display:flex; align-items:center; gap:8px;">
                        <button class="qty-btn" onclick="changeQty(${id}, -1)">-</button>
                        <span>${cart[id].qty}</span>
                        <button class="qty-btn" onclick="changeQty(${id}, 1)">+</button>
                        <button class="delete-item" onclick="removeItem(${id})">&times;</button>
                    </div>
                </div>`;
        }
        document.getElementById('nav-count').innerText = count;
        document.getElementById('nav-total').innerText = total;
        document.getElementById('modalTotal').innerText = total;
        localStorage.setItem('royal_bakery_cart', JSON.stringify(cart));
    }

    function saveUserData() {
        const userData = {
            name: document.getElementById('custName').value,
            phone: document.getElementById('custPhone').value,
            address: document.getElementById('fullAddress').value
        };
        localStorage.setItem('royal_bakery_user', JSON.stringify(userData));
    }

    function loadUserData() {
        const savedData = JSON.parse(localStorage.getItem('royal_bakery_user'));
        if (savedData) {
            document.getElementById('custName').value = savedData.name || '';
            document.getElementById('custPhone').value = savedData.phone || '';
            document.getElementById('fullAddress').value = savedData.address || '';
        }
    }

    async function handleOrder() {
        const name = document.getElementById('custName').value.trim();
        const phone = document.getElementById('custPhone').value.trim();
        const address = document.getElementById('fullAddress').value.trim();
        const notes = document.getElementById('orderNotes').value.trim();
        const total = document.getElementById('modalTotal').innerText;

        if (!name || !address || Object.keys(cart).length === 0) {
            return alert("ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬Ø§Øª Ù„Ù„Ø³Ù„Ø© ğŸ“‹");
        }

        const btn = document.getElementById('sendOrderBtn');
        btn.disabled = true;
        btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØªØ¬Ø±...";

        try {
            const { data: latestStatus } = await _supabase.from('store_settings').select('is_open, closing_message').limit(1).single();
            
            if (latestStatus && !latestStatus.is_open) {
                alert("Ø¹Ø°Ø±Ø§Ù‹ØŒ ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ØªØ¬Ø± Ù„Ù„ØªÙˆ: " + latestStatus.closing_message);
                location.reload(); 
                return;
            }

            await _supabase.from('orders').insert([{
                customer_name: name,
                phone: phone,
                address: address + (userLocationUrl ? " | Ø§Ù„Ù…ÙˆÙ‚Ø¹: " + userLocationUrl : ""),
                items: cart,
                total_price: parseFloat(total),
                status: 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©',
                notes: notes
            }]);

            let message = `*ğŸ§¾ ÙØ§ØªÙˆØ±Ø© Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯Ø© - Ø§Ù„Ù…Ø®Ø¨Ø² Ø§Ù„Ù…Ù„ÙƒÙŠ*ğŸ‘‘%0A`;
            message += `------------------------------%0A`;
            message += `*Ø§Ù„Ø§Ø³Ù…:* ${name}%0A`;
            message += `*Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:* ${address}%0A`;
            
            // Ø¥Ø¶Ø§ÙØ© Ø±Ø§Ø¨Ø· Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨
            if(userLocationUrl) {
                message += `*ğŸ“ Ø§Ù„Ù…ÙˆÙ‚Ø¹ (GPS):* ${userLocationUrl}%0A`;
            }

            if(notes) message += `*Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª:* ${notes}%0A`;
            message += `------------------------------%0A`;
            message += `*Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:*%0A`;

            for (let id in cart) {
                message += `â€¢ ${cart[id].name} (Ã—${cart[id].qty}) - ${cart[id].qty * cart[id].price} Ø±ÙŠØ§Ù„%0A`;
            }

            message += `------------------------------%0A`;
            message += `*ğŸ’° Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${total} Ø±ÙŠØ§Ù„*%0A`;
            message += `Ø´ÙƒØ±Ø§Ù‹ Ù„Ø§Ø®ØªÙŠØ§Ø±ÙƒÙ… Ø§Ù„Ù…Ø®Ø¨Ø² Ø§Ù„Ù…Ù„ÙƒÙŠ ğŸ¥–âœ¨`;

            window.open(`https://wa.me/${storeSettings.whatsapp_number}?text=${message}`, '_blank');
            
            cart = {};
            document.getElementById('orderNotes').value = "";
            userLocationUrl = ""; // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ø¹Ø¯ Ø§Ù„Ø·Ù„Ø¨
            updateUI();
            toggleModal();

        } catch (e) {
            alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
        } finally {
            btn.disabled = false;
            btn.innerText = "ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ ğŸ’¬";
        }
    }

    function toggleModal() {
        const m = document.getElementById('cartModal');
        m.style.display = (m.style.display === 'flex') ? 'none' : 'flex';
    }
</script>
</body>
</html>
